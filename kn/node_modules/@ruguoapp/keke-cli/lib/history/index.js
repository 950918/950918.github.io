#!/usr/bin/env node
const program = require('commander')
const { table } = require('table')
const authRequest = require('../authRequest')
const { KEKE } = require('../consts')

function deploy (options) {
  const { limit, name, group } = options
  authRequest.get(`${KEKE}/management/history`, { params: {
    name,
    group,
    limit
  } }).then((res) => {
    const data = res.data.data.map(x => [x.releasedEnv, x.hash, x.createdAt])
    const output = table([['releasedEnv', 'hash', 'createdAt'], ...data])
    console.log(output)
  }).catch((e) => {
    console.error(e.response.data)
  })
}

function action (command) {
  const limit = command.limit || 10
  const codename = command.codename
  const group = command.group
  if (!codename) {
    console.error('未找到name配置，请检查配置是否正常。')
    return
  }
  if (!group) {
    console.error('未找到group配置，请检查配置是否正常。')
    return
  }

  deploy({
    limit,
    name: codename,
    group: group
  })
}

program
  .command('history')
  .option(
    '-n, --name [codename]',
    '项目名'
  )
  .option(
    '-g, --group [group]',
    '项目所在分组'
  )
  .option(
    '-l --limit [limit]',
    '查询数目限制。'
  )
  .description('查看项目的发布历史。name为项目名，如果不填写将使用package.json里的name配置。')
  .action(action)
