#!/usr/bin/env node
const program = require('commander')
const prompts = require('prompts')
const { writeCredentials } = require('../utils')
const axios = require('axios')
const authRequest = require('../authRequest')
const TOKEN_NAME = 'keke'

async function login (
  source,
  options
) {
  const { phone } = await prompts({
    type: 'text',
    name: 'phone',
    message: '请填写你的手机号'
  })
  await axios.post('https://auth.midway.run/api/user/getVerifyCode', { mobile: phone })
  console.log('✔验证码已经发送到你的手机')
  const { code } = await prompts({
    type: 'text',
    name: 'code',
    message: '请填写手机验证码'
  })
  try {
    const response = await axios.post('https://auth.midway.run/api/user/login', { mobile: phone, code: code })
    const token = response.headers['set-cookie'][0].split(';')[0].split('=')[1]
    authRequest.defaults.headers.common['cookie'] = `JIKE-AUTH-JWT=${token}`
    try {
      await authRequest.post('https://auth.midway.run/api/jtoken/upsert', { name: TOKEN_NAME, policies: ['fe-dpy'] })
    } catch (err) {}
    try {
      const tokenRes = await authRequest.post('https://auth.midway.run/api/jtoken/get', { name: TOKEN_NAME })
      if (tokenRes.data.token) {
        console.log('✏️已找到token，已写入本地文件 ~/.keke/credentials ', tokenRes.data.token)
        writeCredentials('default', tokenRes.data.token)
        console.log('👌登录成功')
      }
    } catch (err) {
      console.log('❌ 未找到token， 请尝试重新运行')
      console.log(err.data)
    }
  } catch (err) {
    console.log(err.data)
  }
}

function action (command) {
  login(command)
}

program
  .command('login')
  .description('登录authcenter，请根据提示操作。')
  .action(action)
