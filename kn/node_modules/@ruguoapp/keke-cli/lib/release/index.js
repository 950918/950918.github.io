#!/usr/bin/env node
const program = require('commander')
const qrcode = require('qrcode-terminal')
const authRequest = require('../authRequest')
const { KEKE } = require('../consts')
function deploy (options) {
  const { env, hash, codename, group } = options
  authRequest.post(`${KEKE}/management/release`,
    {
      name: codename,
      hash,
      group,
      env
    }
  ).then((res) => {
    const { url } = res.data.data
    console.log(`发布到${env}成功`)
    console.log(url)
    qrcode.generate(url, { small: true })
  }).catch((e) => {
    console.error(e.response.data.error)
  })
}

function action (command) {
  const env = command.prod ? 'prod' : 'beta'
  const { codename, group, hash } = command
  if (!codename) {
    console.error('无name配置，请检查配置是否正常。')
    return
  }
  if (!group) {
    console.error('无group配置，请检查配置是否正常。')
    return
  }

  deploy({
    env,
    hash,
    codename,
    group
  })
}

program
  .command('release')
  .option(
    '-n, --codename [codename]',
    '项目名'
  )
  .option(
    '-g, --group <group>',
    '项目所在分组'
  )
  .option(
    '--prod',
    '发布到prod环境，如果不开启此项配置将默认发布到beta环境'
  )
  .option(
    '--hash <hash>',
    '使用history命令查询版本发布历史，填写快照hash用来快速回滚，留空以发布最新的版本。'
  )
  .description('将项目快照发布到线上环境。name为项目名')
  .action(action)

module.exports = action
