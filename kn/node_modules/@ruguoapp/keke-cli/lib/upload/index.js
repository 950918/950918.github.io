#!/usr/bin/env node
const path = require('path')
const chalk = require('chalk')
const program = require('commander')
const fs = require('fs')
const { upload, getPrettierUploadInfo, readDirSync, fileHash } = require('../utils')
const basename = path.basename

async function action (source, command) {
  const { prefix, allowSourcemap, concurrent = 20 } = command
  var path = ''
  const workingDirectory = process.cwd()

  if (source.startsWith('./')) {
    path = workingDirectory + '/' + source.slice(2)
  } else if (source.startsWith('/')) {
    path = source
  } else {
    path = workingDirectory + '/' + source
  }

  var uploadList = readDirSync(path, [], prefix).map(x => ({ ...x, fileData: fs.readFileSync(x.localFile) })).map(x => ({ ...x, md5: fileHash(x.fileData) }))
  if (!allowSourcemap) {
    console.log(
      chalk.bold.red(
        '*.map and .* has been removed, use --allow-sourcemap to enable.'
      )
    )
    uploadList = uploadList.filter(
      (x) =>
        !x.localFile.endsWith('.map') && !basename(x.localFile).startsWith('.')
    )
  }
  console.time('upload')
  const uploadedInfo = await upload(uploadList, { concurrent })
  console.timeEnd('upload')
  getPrettierUploadInfo(uploadedInfo)
}

program
  .command('upload <source>')
  .description('将文件/文件夹上传到OSS')
  .option(
    '-p, --prefix [prefix]',
    '项目名，必填'
  )
  .option('-c, --concurrent [concurrent]', 'the number of concurrent upload.')
  .option('--allow-sourcemap [boolean]', 'allow sourcemap uploading.')
  .action(action)

module.exports = action
